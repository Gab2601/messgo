<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MessGo - Application</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 1rem;
    }
    #auth, #hud {
      margin-top: 1rem;
    }
    #hangar-container > div {
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-radius: 6px;
    }
    #hangar-container img {
      max-width: 100%;
      border-radius: 6px;
    }
    button {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      font-size: 1rem;
      margin: 0.3rem 0;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* Cam√©ra UI */
    #camera-ui {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    video {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      background: black;
    }
    #camera-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <h1>MessGo</h1>

  <!-- AUTH UI -->
  <div id="auth">
    <input type="email" id="email" placeholder="Email" /><br />
    <input type="password" id="password" placeholder="Mot de passe" /><br />
    <button id="login-btn">Connexion</button>
    <button id="signup-btn">Cr√©er un compte</button>
  </div>

  <!-- HUD (apr√®s connexion) -->
  <div id="hud" style="display:none;">
    <p>Connect√© en tant que <strong><span id="username"></span></strong></p>
    <p><span id="points">Points : 0</span></p>

    <button id="capture-btn">üì∏ Prendre une photo</button>
    <button id="logout-btn">Se d√©connecter</button>

    <h2>Ton hangar</h2>
    <div id="hangar-container"></div>

    <!-- Cam√©ra UI -->
    <div id="camera-ui">
      <video id="video" autoplay playsinline></video>
      <div id="camera-buttons">
        <button id="switch-camera-btn">üîÅ Changer cam√©ra</button>
        <button id="snap-btn">üì∏ Prendre photo</button>
        <button id="close-camera-btn">‚ùå Fermer cam√©ra</button>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script type="module">

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // === Config Supabase ===
    const supabaseUrl = 'https://utbrpjpoeoxahuawunqq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0YnJwanBvZW94YWh1YXd1bnFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzI2NzcsImV4cCI6MjA2Mzg0ODY3N30.Q0-qs0hEYXMCv15elyPahXAWrituJ6N51ZtuqQq3C3Q';

    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    // === Cl√© API Aerodatabox ===
    const MAGIC_API_KEY = 'cmb59boxd0001l404udrrm5r7';  // Ta cl√© X-MagicAPI-Key
    const AERODATABOX_API_URL = 'https://prod.api.market/api/v1/aedbx/aerodatabox/aircrafts/recognize/beta';

    // === DOM elements ===
    const authBox = document.getElementById('auth');
    const hud = document.getElementById('hud');
    const usernameSpan = document.getElementById('username');
    const pointsSpan = document.getElementById('points');
    const hangarContainer = document.getElementById('hangar-container');

    const captureBtn = document.getElementById('capture-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // Cam√©ra UI
    const cameraUI = document.getElementById('camera-ui');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const switchCameraBtn = document.getElementById('switch-camera-btn');
    const snapBtn = document.getElementById('snap-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');

    // Variables cam√©ra
    let videoStream = null;
    let usingFrontCamera = false;

    // === AUTH ===
    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        alert('Merci de remplir email et mot de passe');
        return;
      }
      const { error, data } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
      else {
        currentUser = data.user;
        showApp();
      }
    };

    document.getElementById('signup-btn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        alert('Merci de remplir email et mot de passe');
        return;
      }
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message);
      else alert("Compte cr√©√©, connecte-toi !");
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      authBox.style.display = 'block';
      hud.style.display = 'none';
      clearInputs();
      stopCamera();
    };

    // === Initialisation session ===
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        currentUser = session.user;
        showApp();
      } else {
        authBox.style.display = 'block';
        hud.style.display = 'none';
      }
    })();

    function clearInputs() {
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    }

    // === Affichage app apr√®s connexion ===
    async function showApp() {
      authBox.style.display = 'none';
      hud.style.display = 'block';

      usernameSpan.textContent = currentUser.email;

      await loadHangar();
      await refreshPoints();
    }

    // === Chargement hangar ===
    async function loadHangar() {
      const { data, error } = await supabase
        .from('photos')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erreur chargement hangar:', error.message);
        hangarContainer.innerHTML = '<p>Erreur chargement hangar</p>';
        return;
      }

      if (!data.length) {
        hangarContainer.innerHTML = '<p>Ton hangar est vide, prends une photo !</p>';
        return;
      }

      hangarContainer.innerHTML = '';

      data.forEach(photo => {
        const card = document.createElement('div');
        card.innerHTML = `
          <img src="${photo.photo_url}" alt="${photo.plane_model}" />
          <div><strong>${photo.plane_model}</strong></div>
          <div>Points : ${photo.points}</div>
        `;
        hangarContainer.appendChild(card);
      });
    }

    // === Calcul points ===
    async function refreshPoints() {
      const { data, error } = await supabase
        .from('photos')
        .select('points')
        .eq('user_id', currentUser.id);

      if (error) {
        console.error('Erreur points:', error.message);
        pointsSpan.textContent = 'Points : 0';
        return;
      }

      const total = data.reduce((acc, p) => acc + p.points, 0);
      pointsSpan.textContent = `Points : ${total}`;
    }

    // === CAMERA SYSTEM ===

    async function startCamera() {
      if (videoStream) {
        stopCamera();
      }
      const constraints = {
        audio: false,
        video: {
          facingMode: usingFrontCamera ? 'user' : 'environment'
        }
      };

      try {
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = videoStream;
        cameraUI.style.display = 'flex';
        captureBtn.style.display = 'none';
      } catch (err) {
        alert('Erreur acc√®s cam√©ra : ' + err.message);
      }
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      cameraUI.style.display = 'none';
      captureBtn.style.display = 'inline-block';
    }

    function switchCamera() {
      usingFrontCamera = !usingFrontCamera;
      startCamera();
    }

    async function takePhoto() {
      const width = video.videoWidth;
      const height = video.videoHeight;

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      // Convertit la photo en Blob (pour upload)
      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), 'image/jpeg');
      });
    }

    // === Gestion prise photo et upload ===
    captureBtn.onclick = async () => {
      await startCamera();
    };

    snapBtn.onclick = async () => {
      const photoBlob = await takePhoto();

      // G√©n√®re un nom fichier
      const fileName = `${currentUser.id}/${Date.now()}.jpg`;

      // Upload dans Supabase Storage
      const { error: uploadError } = await supabase.storage.from('photos').upload(fileName, photoBlob, {
        cacheControl: '3600',
        upsert: false
      });

      if (uploadError) {
        alert('Erreur upload: ' + uploadError.message);
        return;
      }

      // R√©cup√©rer l'URL publique
      const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(fileName);

      // Reconnaissance avion (optionnelle)
      let planeModel = 'Avion inconnu';

      try {
        // Convertir Blob en base64
        const base64 = await blobToBase64(photoBlob);

        const response = await fetch(AERODATABOX_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-MagicAPI-Key': MAGIC_API_KEY,
          },
          body: JSON.stringify({
            image: base64.split(',')[1]
          }),
        });

        if (response.ok) {
          const result = await response.json();
          if (result && result.aircrafts && result.aircrafts.length > 0) {
            planeModel = result.aircrafts[0].model.name || planeModel;
          }
        }
      } catch (e) {
        console.warn('Erreur reconnaissance avion:', e);
      }

      // Insert dans Supabase DB
      const { error: insertError } = await supabase.from('photos').insert({
        user_id: currentUser.id,
        photo_url: publicUrl,
        plane_model: planeModel,
        points: 10,
        created_at: new Date().toISOString()
      });

      if (insertError) {
        alert('Erreur base: ' + insertError.message);
        return;
      }

      // Actualise hangar et points
      await loadHangar();
      await refreshPoints();

      // Ferme cam√©ra
      stopCamera();
    };

    closeCameraBtn.onclick = () => {
      stopCamera();
    };

    switchCameraBtn.onclick = () => {
      switchCamera();
    };

    // Utilitaire conversion Blob en base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
      });
    }

  </script>

</body>
</html>
